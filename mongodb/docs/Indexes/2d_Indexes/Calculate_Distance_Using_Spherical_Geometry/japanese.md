# Calculate Distance Using Spherical Geometry
**WARNING**
球形クエリには、2dsphere インデックスの結果を使用します。

球形クエリに2dインデックスを使用すると、極を回り込むような不正な結果になることがあります。

---

2d インデックスは、ユークリッド平面（平面）上の距離を計算するクエリをサポートしています。また、球面形状を使用して距離を計算する以下の問い合わせ演算子やコマンドもサポートしています。

NOTE
球面距離を使用した基本的なクエリは 2d インデックスでサポートされていますが、データが主に経度と緯度である場合は 2dsphere インデックスへの移行を検討してください。

- $nearSphere
- $centerSphere
- $near
- $geoNear pipeline stage with the spherical: true option

前述の操作では、距離にラジアンを使用します。他の球体クエリ演算子 ($geoWithin など) はそうではありません。

球形クエリ演算子を正しく動作させるには、 距離をラジアン単位に変換し、 アプリケーションで使用する距離単位をラジアン単位から変換する必要があります。

変換するには
- 距離をラジアンへ: 距離を球体 (地球など) の半径で割り、その単位は距離の測定単位と同じにします。
- ラジアンから距離へ： 距離を変換したい単位系で、ラジアン測定値を球体（例えば地球）の半径で掛ける。

地球の赤道半径は、約 3,963.2 マイルまたは 6,378.1 キロメートルです。

次のクエリは、中心[ -74, 40.74 ]、半径100マイルで記述された円内の場所コレクションからドキュメントを返します。

```bash
db.places.find( { loc: { $geoWithin: { $centerSphere: [ [ -74, 40.74 ] ,
                                                     100 / 3963.2 ] } } } )
```

緯度と経度の座標を指定する場合は、まず経度を記載し、次に緯度を記載します。

- 有効な経度の値は-180から180の間です。
- 緯度の有効範囲は-90〜90です。
