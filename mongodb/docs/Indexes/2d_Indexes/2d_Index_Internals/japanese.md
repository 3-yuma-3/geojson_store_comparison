# 2d Index Internals
このドキュメントでは、MongoDB の 2 次元地理空間インデックスの内部について、より詳しく説明します。この資料は、通常の運用やアプリケーションの開発には必要ありませんが、 トラブルシューティングや理解を深めるのには役に立つかもしれません。

## Calculation of Geohash Values for 2d Indexes
レガシー座標ペアで地理空間インデックスを作成すると、 MongoDB は指定した位置範囲内の座標ペアについてジオハッシュ値を計算し、 そのジオハッシュ値でインデックスを作成します。

ジオハッシュ値を計算するには、二次元の地図を再帰的に四分円に分割します。そして、各象限には2ビットの値を割り当てる。例えば、4つの象限を2ビットで表現すると、次のようになります。

```
01  11

00  10
```

この2ビットの値（00、01、10、11）は、各象限と各象限内のすべての点を表します。2ビットの分解能を持つジオハッシュの場合、左下の象限内のすべてのポイントは00のジオハッシュを持つことになります。左上の象限はジオハッシュが01になります。右下と右上はそれぞれ10と11のジオハッシュを持つことになります。

さらに精度を上げるために、各象限をサブ象限に分割していきます。それぞれのサブ象限は、含む象限のジオハッシュの値とサブ象限の値が連結されたものとなります。右上の象限を表すジオハッシュは11で、サブ象限を表すジオハッシュは（左上から時計回りに）次のようになります。それぞれ、1101、1111、1110、1100となります。

## Multi-location Documents for 2d Indexes
2d 地理空間インデッ クスでは、 1 つの文書内に複数の地理空間フ ィ ール ド を持つ こ と はで き ませんが、 マルチキー イ ンデ ッ ク ス を用いれば、 1 つの文書内の複数の座標対を イ ンデ ッ ク スす る こ と がで き ます。最も単純な例では、次の例のように、座標の配列を保持するフィールド (locs など) を持つことができます。

```bash
db.places.save( {
  locs : [ [ 55.5 , 42.3 ] ,
           [ -74 , 44.74 ] ,
           { lng : 55.5 , lat : 42.3 } ]
} )
```

配列の値は、[ 55.5, 42.3 ] のような配列でも、 { lng : 55.5 , lat : 42.3 } のような埋め込み文書でもかまいません。

そして、以下のように、locsフィールドに地理空間インデックスを作成することができます。

```bash
db.places.createIndex( { "locs": "2d" } )
```

また、位置情報を埋め込み文書の中のフィールドとしてモデル化することもできる。この場合、文書には、文書の配列を保持するフィールド (例: address) が含まれ、各文書には位置座標を保持するフィールド (例: loc:) が含まれることになります。例えば

```bash
db.records.save( {
  name : "John Smith",
  addresses : [ {
                 context : "home" ,
                 loc : [ 55.5, 42.3 ]
                } ,
                {
                 context : "work",
                 loc : [ -74 , 44.74 ]
                }
              ]
} )
```

そして、次の例のように、address.locフィールドに地理空間インデックスを作成することができます。

```bash
db.records.createIndex( { "addresses.loc": "2d" } )
```
