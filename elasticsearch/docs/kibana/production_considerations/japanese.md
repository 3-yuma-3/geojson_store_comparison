# Use Kibana in a production environment
Kibanaをどのようにデプロイするかは、ユースケースに大きく依存します。ユーザが自分だけであれば、ローカルマシンでKibanaを実行し、対話したいElasticsearchインスタンスを指すように設定することができます。逆に、多数のヘビーな Kibana ユーザーがいる場合、同じ Elasticsearch インスタンスに接続されている複数の Kibana インスタンス間でロードバランスを取る必要があるかもしれません。

Kibanaはそれほどリソースを消費しませんが、それでもElasticsearchのデータノードやマスターノードとは別にKibanaを実行することをお勧めします。Kibana のトラフィックを Elasticsearch クラスター内のノードに分散させるには、Elasticsearch ホストのリストを使用するように Kibana を設定することができます。

Kibana はローリングアップグレードをサポートしておらず、Kibana の混合バージョンをデプロイすると、データの損失やアップグレードの失敗が発生する可能性があります。アップグレードを行う前に Kibana のすべてのインスタンスをシャットダウンし、実行中のすべての Kibana インスタンスのバージョンが一致することを確認してください。

## Load balancing across multiple Kibana instances
ロードバランサーの背後にインストールされた複数の Kibana を提供するには、設定を変更する必要があります。各設定の詳細については、「Configuring Kibana」を参照してください。

これらの設定は、各 Kibana インスタンスで一意である必要があります。

```
server.uuid // if not provided, this is autogenerated
server.name
path.data
pid.file
server.port
```

ファイルアペンダーを使用する場合、ターゲットファイルも一意でなければなりません。

```yml
logging:
  appenders:
    default:
      type: file
      fileName: /unique/path/per/instance
```

同じでなければならない設定。

```yml
xpack.security.encryptionKey //decrypting session information
xpack.reporting.encryptionKey //decrypting reports
xpack.encryptedSavedObjects.encryptionKey // decrypting saved objects
xpack.encryptedSavedObjects.keyRotation.decryptionOnlyKeys // saved objects encryption key rotation, if any
```

cフラグを使用することで、コマンドラインから別の設定ファイルを使用することができます。

```
bin/kibana -c config/instance1.yml
bin/kibana -c config/instance2.yml
```

## Accessing multiple load-balanced Kibana clusters
同じブラウザから負荷分散された複数の Kibana クラスターにアクセスするには、各 Kibana インスタンスの Kibana 設定で xpack.security.cookieName に同じ値を明示的に設定します。

各 Kibana クラスターには、異なる値の xpack.security.cookieName を設定する必要があります。

これにより、異なる Kibana インスタンスからの Cookie 間の競合を回避できます。

これにより、シームレスな高可用性を実現し、現在使用しているインスタンスから障害が発生した場合でも、セッションを有効に保つことができます。

## High availability across multiple Elasticsearch nodes
Kibanaは、同じクラスタ内の複数のElasticsearchノードに接続するように設定することができます。ノードが利用できなくなった場合、Kibana は利用可能なノードに透過的に接続し、動作を継続します。利用可能なホストへのリクエストは、ラウンドロビン方式でルーティングされます。

kibana.yml にあります。

```yml
elasticsearch.hosts:
  - http://elasticsearch1:9200
  - http://elasticsearch2:9200
```

関連する設定には、elasticsearch.sniffInterval、elasticsearch.sniffOnStart、elasticsearch.sniffOnConnectionFaultがあります。これらは、クラスタのサイズ変更に伴い、ホストのリストを自動的に更新するために使用することができます。パラメータは設定ページで確認することができます。

## Memory
Kibana にはデフォルトのメモリ制限があり、利用可能な総メモリ量に基づいて拡張されます。大規模なレポーティング ジョブなどのシナリオでは、より具体的な要件を満たすために制限を微調整することが理にかなっている場合があります。

制限は、kibana/config フォルダーまたは環境変数 KBN_PATH_CONF で設定されたその他のフォルダー内にある node.options 設定ファイルで --max-old-space-size を設定することにより定義することができる。例えば、Debianベースのシステムでは、そのフォルダは/etc/kibanaです。

このオプションでは、MB単位で制限を受け付けます。

```
--max-old-space-size=2048
```
